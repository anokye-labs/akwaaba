# Commit Validation

This document describes the commit validation system used in this repository to ensure all commits reference open GitHub issues.

## Overview

All commits in pull requests must reference at least one open GitHub issue. This ensures:
- Traceability: Every change has a documented reason
- Context: Reviewers understand the "why" behind changes
- Coordination: Work is tracked through issues
- Auditability: History is searchable and meaningful

## Validation Process

When a pull request is opened or updated, the Commit Validator workflow:
1. Fetches all commits in the PR
2. Checks each commit message for issue references
3. Verifies referenced issues exist and are open
4. Handles edge cases (merge commits, reverts, bots, WIP)
5. Posts detailed feedback on validation failures

## Valid Issue Reference Formats

Commits can reference issues in several ways:

### Simple Reference
```
feat: Add new feature #123
```
Uses `#` followed by the issue number.

### Keyword References
```
fix: Resolve bug Closes #456
feat: Implement feature Fixes #789
docs: Update guide Resolves #101
```
Keywords `Closes`, `Fixes`, and `Resolves` (case-insensitive) link commits to issues.

### Cross-Repository References
```
feat: Use utility from anokye-labs/common#123
```
Format: `owner/repo#issue_number`

### Full URL References
```
feat: Implement https://github.com/anokye-labs/akwaaba/issues/123
```
Complete GitHub issue URL.

### Multiple References
```
feat: Add features #123 #456 Closes #789
```
A single commit can reference multiple issues.

## Edge Cases

The validator automatically handles several edge cases:

### 1. Merge Commits

**Behavior**: Automatically skipped

Merge commits are generated by Git and don't represent work items. They are excluded from validation.

**Examples**:
- `Merge pull request #123 from user/branch`
- `Merge branch 'feature' into main`
- `Merge remote-tracking branch 'origin/main'`

### 2. Revert Commits

**Behavior**: Allowed without issue reference

Revert commits undo previous changes and are considered maintenance operations. They don't require an issue reference.

**Examples**:
- `Revert "Add broken feature"`
- `Revert abc1234`

**Best Practice**: While not required, consider referencing the issue that tracked the original problematic commit.

### 3. Bot Commits

**Behavior**: Allowed without issue reference

Commits from approved bots are excluded from validation. These bots perform automated tasks that don't correspond to human-created issues.

**Approved Bots**:
- `github-actions[bot]`
- `dependabot[bot]`
- `renovate[bot]`

**Examples**:
- Dependency updates from Dependabot
- Automated formatting from GitHub Actions
- Version bumps from Renovate

### 4. WIP (Work In Progress) Commits

**Behavior**: Warning issued but validation passes

WIP commits are allowed to support iterative development, but a warning encourages developers to:
- Update commit messages before merging
- Squash WIP commits into meaningful commits
- Maintain a clean commit history

**Examples**:
- `WIP: Working on authentication`
- `[WIP] Experimenting with new API`
- `wip: trying different approach`

**Best Practice**: Before merging, either:
1. Update WIP commit messages to be descriptive with issue references
2. Squash WIP commits into a single, well-described commit

## Validation Workflow

The validation is performed by:
- **Workflow**: `.github/workflows/commit-validator.yml`
- **Script**: `scripts/Validate-Commits.ps1`
- **Tests**: `scripts/Test-Validate-Commits.ps1`

### Workflow Triggers

The validator runs on:
- Pull request opened
- Pull request synchronized (new commits pushed)
- Pull request reopened

### Permissions

The workflow requires:
- `contents: read` - To access repository code
- `pull-requests: write` - To post comments on PRs
- `issues: read` - To verify issue existence and status

## Handling Validation Failures

When validation fails, you'll see:
1. A failed check on your pull request
2. A comment detailing which commits failed and why
3. Instructions on how to fix the issues

### Common Failures

#### No Issue Reference
```
✗ abc1234: feat: Add new feature
  Reason: No issue reference found
```

**Fix**: Update the commit message to include an issue reference:
```bash
git commit --amend -m "feat: Add new feature #123"
git push --force
```

#### Closed Issue Reference
```
✗ def5678: fix: Resolve bug #456
  Reason: No open issue found. References: owner/repo#456
```

**Fix**: Reference an open issue instead, or reopen the closed issue if appropriate.

#### Issue Doesn't Exist
```
✗ ghi9012: feat: New feature #999
  Reason: No open issue found. References: owner/repo#999
```

**Fix**: Create the issue first, then update the commit message with the correct issue number.

### Fixing Commit Messages

#### For the Last Commit
```bash
git commit --amend -m "feat: Add feature #123"
git push --force
```

#### For Older Commits
```bash
# Interactive rebase to edit older commits
git rebase -i HEAD~3  # Replace 3 with number of commits to go back

# Mark commits to edit with 'reword' or 'r'
# Save and close editor
# Update each commit message when prompted
# Force push when done
git push --force
```

#### Alternative: Squash and Rewrite
```bash
# Squash all commits in your PR into one
git reset --soft origin/main
git commit -m "feat: Complete feature implementation Closes #123"
git push --force
```

## Testing

Run the test suite to verify validation logic:

```powershell
./scripts/Test-Validate-Commits.ps1
```

The tests cover:
- All edge case detection (merge, revert, bot, WIP)
- Issue reference extraction (all formats)
- Multiple references in one commit
- Combinations (e.g., WIP with issue reference)

## Security Considerations

The validator:
- Uses a GitHub token with minimal required permissions
- Does not expose sensitive information in logs or comments
- Validates issue references against the GitHub API
- Handles API rate limiting gracefully

## Contributing

If you need to modify the validation logic:

1. Update `scripts/Validate-Commits.ps1`
2. Add corresponding tests in `scripts/Test-Validate-Commits.ps1`
3. Run tests to verify changes
4. Update this documentation
5. Reference the issue tracking your change in the commit message

## FAQ

### Can I disable validation for a specific PR?

No. Commit validation is a required check and cannot be bypassed. This ensures consistency across all contributions.

### What if I'm working on exploratory code?

Use WIP commits during development. Before merging:
- Create an issue for the work
- Squash or update commits to reference the issue

### Can I reference issues from other repositories?

Yes, use the cross-repository format: `owner/repo#123`

### What if I forgot to reference an issue?

Update your commit message using `git commit --amend` (for the last commit) or `git rebase -i` (for older commits), then force push.

### Are issue references case-sensitive?

Keywords (Closes, Fixes, Resolves) are case-insensitive. Issue numbers and repository names are case-sensitive.

### Can I use issue references in the commit body?

Yes, issue references are detected anywhere in the commit message (subject line or body).

## Examples

### Good Commits

```
feat: Add user authentication Closes #123
```

```
fix: Resolve memory leak in worker pool

This fixes a critical bug where worker goroutines weren't
properly released, causing memory growth over time.

Fixes #456
```

```
docs: Update API documentation #789
```

```
refactor: Simplify error handling #111 #222

- Consolidate error types
- Add better error messages
- Improve logging
```

### Bad Commits (Will Fail Validation)

```
feat: Add user authentication
```
Missing issue reference.

```
fix: Resolve bug #999
```
If issue #999 doesn't exist or is closed.

```
Update stuff
```
No issue reference and vague description.

### Edge Cases (Will Pass with Note)

```
Merge pull request #123 from user/feature-branch
```
Merge commit - automatically skipped.

```
Revert "Add broken authentication"
```
Revert commit - allowed without issue reference.

```
[WIP] Experimenting with new API
```
WIP commit - warning issued but passes.

## Related Documentation

- [CONTRIBUTING.md](../CONTRIBUTING.md) - General contribution guidelines
- [How We Work](../how-we-work.md) - Issue-first workflow
- [Agent Conventions](../how-we-work/agent-conventions.md) - For AI agents

---

For questions or issues with the validation system, please create an issue with the `question` label.
