name: Commit Validator

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  validate-commits:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for commit validation
      
      - name: Validate commit messages
        id: validate
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Run the validation script
          pwsh -File scripts/Validate-Commits.ps1 -PRNumber ${{ github.event.pull_request.number }} -Verbose
          
          # Capture the exit code
          EXIT_CODE=$?
          
          # Set output for next step
          if [ $EXIT_CODE -eq 0 ]; then
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          else
            echo "validation_passed=false" >> $GITHUB_OUTPUT
          fi
          
          exit $EXIT_CODE
      
      - name: Post validation failure comment
        if: failure() && steps.validate.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            // Create a detailed comment for the PR
            const comment = `## ❌ Commit Validation Failed
            
            One or more commits in this PR do not reference an open GitHub issue.
            
            Please check the workflow logs above for detailed information about which commits failed and how to fix them.
            
            ### Quick Fix Guide
            
            **Option 1: Amend the most recent commit**
            \`\`\`bash
            git commit --amend -m "your commit message #123"
            git push --force
            \`\`\`
            
            **Option 2: Interactive rebase (for multiple commits)**
            \`\`\`bash
            git rebase -i HEAD~N  # where N is the number of commits
            # Mark commits with 'reword' to edit their messages
            git push --force
            \`\`\`
            
            **Option 3: Create a new issue**
            1. Create a GitHub issue describing this work
            2. Amend your commit(s) to reference the new issue
            3. Push the updated commits
            
            ### Resources
            
            - [Contribution Guidelines](https://github.com/anokye-labs/akwaaba/blob/main/CONTRIBUTING.md)
            - [How We Work](https://github.com/anokye-labs/akwaaba/blob/main/how-we-work.md)
            
            ---
            
            **Why we do this:** The issue-first workflow ensures all changes are tracked, documented, and coordinated through GitHub issues. This enables effective collaboration between humans and AI agents.
            
            Once you've updated your commits, this check will automatically re-run. ✨`;
            
            // Check if we already posted a comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Commit Validation Failed')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
      
      - name: Delete validation failure comment on success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            // Find and delete any existing failure comments
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Commit Validation Failed')
            );
            
            if (botComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id
              });
            }
